#!/usr/bin/env ruby

# It should do something at the end of each pomodoro (ring). -> another launchd script
# TODO: If the last pomodoro is still active, adjust it so it's finished.
# OS X: It could show time remaning in the top-right bar.

require 'internet-usage-limiter'
require 'pomodoro/exts/hour'

# Usage:
#
# pomodoro [purpose of the session #tags] [time in minutes (defaults to 10)]
# pomodoro for the status

if ARGV.empty? || ARGV.include?('--prompt') || ARGV.include?('--bitbar') || ARGV.include?('--commit-message')
  log = InternetUsageLimiter::LogReader.new
  if log.entries.last && log.entries.last.active?
    if ARGV.include?('--prompt')
      entry = log.entries.last
      puts "#{entry.description} [#{Hour.new(0, entry.time_till_the_end)}] "
    elsif ARGV.include?('--bitbar')
      entry = log.entries.last
      time_till_the_end = Hour.new(0, entry.time_till_the_end)
      # Here it's actually min:s.
      color = (time_till_the_end < Hour.new(0, 5 * 60)) ? 'red' : 'green'
      puts "#{time_till_the_end} | color=#{color}"
      puts "---"
      puts entry.description
      # TODO: Show a message if not set -> so I use the shit more.
    elsif ARGV.include?('--commit-message')
      description = log.entries.last.description
      # Pomodoro: fix a bug -> Fix a bug.
      puts description.sub(/^[^\s]+:\s*(.)(.+)$/) { "#{$1.upcase}#{$2}" }
    else
      puts log.entries.last
    end
  else
    exit 1
  end
elsif ARGV.include?('--delete')
  # TODO: Delete the last item.
elsif ARGV.include?('--finish')
  # TODO: Finish the last pomodoro (which will make you go offline if it was #online).
else
  reason_and_tags = ARGV.grep(/^\D+$/).join(' ')
  minutes = ARGV.last.match(/^\d+$/) { |match| match[0].to_i } || 10

  log_file_path = InternetUsageLimiter.config.log_file_path

  File.open(log_file_path, 'a') do |file|
    file.puts("#{Time.now.strftime('%d/%m/%Y %H:%M')} (#{minutes}min) #{reason_and_tags}")
  end
end
