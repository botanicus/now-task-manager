#!/usr/bin/env ruby

# Today:
# - [20] Meditation. #meditation
#   {started: '9:20', 'finished': '10:20', pomodoros: 4, waiting_for: 'Email from ...'}
# - [20] Dancing.
# - [15] TopTal. #online #work
# - Some cleanup.
# - [90] Write a blog post. #online
# - Plan tomorrow.

require 'pomodoro'
require 'pomodoro/exts/hour'

TASK_LIST_PATH = File.expand_path('~/Dropbox/WIP/tasks.todo')
manager = Pomodoro::TaskManager.parse(TASK_LIST_PATH)

case ARGV.shift
when 'postpone', 'skip', 'discard'
  abort 'Currently found unnecessary. Pomodoro is trying to be simple and against skipping.'
when 'next'
  abort "No more tasks." if manager.today_tasks.empty?
  task = manager.active_task

  if task.command
    puts task.text
    puts %x{#{task.command}} # TODO: Time.timer -> update log-time.
  else
    arguments = "#{task.text} #{task.tags.map { |tag| "##{tag}" }.join(' ')} #{task.duration}"
    command = "log-time #{arguments.split(' ').map { |word| "'#{word}'" }.join(' ')}"
    puts command; system command
  end

  manager.mark_active_task_as_done
  manager.save
when 'next?'
  abort "No more tasks." if manager.today_tasks.empty?
  task = manager.active_task
  puts "#{task.text} #{task.tags.map { |tag| "##{tag}" }.join(' ')} #{task.duration}"
when 'today'
  unfinished_tasks = manager.today_tasks.select { |task| ! task.tags.include?(:done) }
  unless unfinished_tasks.empty?
    puts unfinished_tasks
    puts; puts "Time to done: #{Hour.new(0, unfinished_tasks.sum(&:duration))}."
  else
    puts "All done!"
  end
when 'punch-off'
  path = File.expand_path("~/Dropbox/WIP/Tasks/#{Time.now.strftime('%Y-%m-%d')}.todo")
  abort "File #{path} already exists!" if File.exists?(path)

  finished_tasks = manager.finished_tasks.map do |task|
    tags = task.tags - [:done]
    Pomodoro::Task.new(task.text, task.duration, tags)
  end

  unless ARGV.include?('--dry-run')
    File.open(path, 'w') do |file|
      file.puts("\n\n")
      file.puts(finished_tasks)
    end
    # puts "Well done! Today you have done:\n\n"
    # puts(finished_tasks)
    system("vim #{path}")
  else
    puts "#{path}:"
    puts(finished_tasks)
  end

  manager.switch_days(File.expand_path('~/.config/pomodoro/schedules/base.rb'))
  if ARGV.include?('--dry-run')
    puts "\n\nTomorrow:"
    puts manager.today_tasks
  else
    manager.save
    system "vim #{TASK_LIST_PATH}"
  end
  manager = Pomodoro::TaskManager.parse(TASK_LIST_PATH)
  puts; puts "Total time: #{Hour.new(0, manager.today_tasks.sum(&:duration))}."
when 'add', '+'
  if File.exists?('tasks.todo') && ARGV[0].downcase.match("#{File.basename(Dir.pwd)}:")
    # TODO: Fails for .bitbar.
    puts "~ Appending locally."
    manager = Pomodoro::TaskManager.parse('tasks.todo')
    tasks = manager.instance_variable_get(:@tasks)
    tasks[:tasks] ||= []
    tasks[:tasks].push(Pomodoro::Task.new(ARGV.join(' ')))
    manager.save
  else
    manager.add_task_for_later(ARGV.join(' '))
    manager.save
  end
when 'edit'
  editor = ARGV.shift || ENV['EDITOR']
  exec "#{editor} #{TASK_LIST_PATH}"
when 'show-projects'
  schedule = Pomodoro::Scheduler.load(File.expand_path('~/.config/pomodoro/schedules/base.rb'))
  puts schedule.projects
  puts "\n#{schedule.projects.length} in total, repeats every #{((schedule.projects.length * 7) / 30.0).round(2)} months."
when 'show-schedule'
  require 'date'

  if date_string = ARGV.shift
    date = Date.parse(date_string)
  else
    date = Date.today
  end

  schedule = Pomodoro::Scheduler.load(File.expand_path('~/.config/pomodoro/schedules/base.rb'), date)

  puts "#{date.strftime('%A %d/%m/%Y')}:"
  schedule = schedule.for_today(true)
  puts; puts schedule
else
  abort "Usage: #{File.basename($0)} [next|next?|today|punch-off|add|edit|show-projects|show-schedule]."
end
