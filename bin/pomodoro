#!/usr/bin/env ruby

require 'pomodoro'
require 'pomodoro/exts/hour'

config  = Pomodoro::Config.new
# manager = Pomodoro::TaskManager.parse(config.task_list_path)
if File.exist?(config.today_path)
  today_tasks = Pomodoro::TaskList.parse(config.today_path)
end

def generate_todays_tasks(date, config)
  require 'pomodoro/scheduler'

  date_path = config.today_path(date)

  scheduler = Pomodoro::Scheduler.load([config.schedule_path, config.routine_path], date)

  schedule = scheduler.schedule_for_date(Date.today)
  task_list = schedule.call
  scheduler.populate_from_rules(task_list)

  File.open(date_path, 'w') do |file|
    file.puts(task_list.to_s)
  end

  return date_path
end

case ARGV.shift
when 'edit', 'e'
  date_path = generate_todays_tasks(Date.today, config) unless File.exist?(config.today_path)
  exec("vim -O2 #{config.today_path} #{config.task_list_path}")
when 'plan-tomorrow'
  date_path = generate_todays_tasks(Date.today + 1, config)
  exec("vim -O2 #{date_path} #{config.task_list_path}")
when 'bitbar'
  require 'pomodoro/commands/bitbar'

  current_time_frame = today_tasks.get_current_time_frame

  colour, icon = Pomodoro::Commands::BitBar.heading(current_time_frame)

  puts icon, '---'

  if current_time_frame
    if current_time_frame.interval[1]
      puts "#{current_time_frame.interval[0]}-#{current_time_frame.interval[1]} (#{current_time_frame.remaining_duration}h remaining) | color=#{colour}"
    else
      puts "After #{current_time_frame.interval[0]} | color=gray"
    end
    current_time_frame.tasks.each do |task|
      colour = {unstarted: 'blue', in_progress: 'red', finished: 'gray', postponed: 'gray'}[task.status]
      puts "#{task} | color=#{colour}"
    end
  elsif Time.now.hour < 14
    today_tasks.each do |time_frame|
      task_lines = time_frame.to_s.split("\n")[1..-1]
      puts "#{time_frame.header} | color=#{task_lines.empty? ? 'gray' : 'green'}"
      puts task_lines.map { |line| "#{line} | color=black" }.join("\n").gsub(/^- /, '-- ')
    end
    puts "Total: XYZ | colour=gray"
  else
    puts "Hours worked: #{Hour.new(0, today_tasks.duration)}"
  end

when 'postpone'
  # TODO: postpone with a reason provided.
when 'next'
  current_time_frame = today_tasks.get_current_time_frame
  active_task = current_time_frame.active_task

  abort "No more tasks." unless active_task

  # if active_task.command
  #   puts task.text
  #   puts %x{#{task.command}} # TODO: Time.timer -> update log-time.
  # else
    # arguments = "#{task.text} #{task.tags.map { |tag| "##{tag}" }.join(' ')} #{task.duration}"
    # command = "log-time #{arguments.split(' ').map { |word| "'#{word}'" }.join(' ')}"
    # puts command; system command
  # end

  start_time = active_task.start
  # today_tasks.save

  loop do
    %x{clear}
    puts "[#{active_task.remaining_duration(current_time_frame)}] #{active_task.text}"
    sleep 1
  end

  active_task.finish
  # today_tasks.save
when 'next?'
  abort "No more tasks." if manager.today_tasks.empty?
  task = manager.active_task
  puts "#{task.text} #{task.tags.map { |tag| "##{tag}" }.join(' ')} #{task.duration}"
when 'today'
  unfinished_tasks = manager.today_tasks.select { |task| ! task.tags.include?(:done) }
  unless unfinished_tasks.empty?
    puts unfinished_tasks
    puts; puts "Time to done: #{Hour.new(0, unfinished_tasks.sum(&:duration))}."
  else
    puts "All done!"
  end
when 'punch-off'
  require 'date' # TODO: use the lib.

  date = ARGV.include?('--yesterday') ? Date.today.prev_day : Date.today
  path = File.expand_path("~/Dropbox/Data/Data/Pomodoro/Tasks/#{date.strftime('%Y-%m-%d')}.todo")

  abort "File #{path} already exists!" if File.exists?(path)

  finished_tasks = manager.finished_tasks.map do |task|
    tags = task.tags - [:done]
    Pomodoro::Task.new(task.text, task.duration, tags)
  end

  unless ARGV.include?('--dry-run')
    lines = File.readlines(File.expand_path('~/Dropbox/Data/Data/Pomodoro/Pomodoro.log'))
    log_items = lines.grep(/^#{date.strftime('%d/%m/%Y')} /)
    File.open(path, 'w') do |file|
      file.puts("\n\n")
      file.puts(finished_tasks)
      file.puts("\n")
      file.puts(log_items)
    end
    # puts "Well done! Today you have done:\n\n"
    # puts(finished_tasks)
    system("vim #{path}")
  else
    puts "#{path}:"
    puts(finished_tasks)
  end

  manager.switch_days(date.next_day, File.expand_path('~/Dropbox/Data/Data/Pomodoro/schedules/base.rb'))
  if ARGV.include?('--dry-run')
    puts "\n\nTomorrow:"
    puts manager.today_tasks
  else
    manager.save
    system "vim #{TASK_LIST_PATH}"
  end
  manager = Pomodoro::TaskManager.parse(TASK_LIST_PATH)
  puts; puts "Total time: #{Hour.new(0, manager.today_tasks.sum(&:duration))}."
when 'review-and-plan'
  today = Date.today

  # TODO: Quarters currently unsupported. Don't be lazy, do it manually!
  interval = if today == Date.parse('1/1') then :year
          elsif today == Date.parse("1/#{today.month}") then :month
          elsif today.sunday? then :week
          else raise("Unknown interval")
  end

  today_date_string = Date.today.strftime('%Y-%m-%d')

  review_path = File.expand_path("~/Dropbox/Data/Tasks/#{today_date_string}.#{interval}.review")
  plan_path   = File.expand_path("~/Dropbox/Data/Tasks/#{today_date_string}.#{interval}.plan")

  File.open(review_path, 'w') do |file|
    file.puts <<-EOF
# How did the week go?
# Observations? Diet, drinking, state of mind ...
    EOF
  end

  File.open(plan_path, 'w') do |file|
    file.puts <<-EOF
# Important, urgent, long-term.
    EOF
  end

  system("vim '#{review_path}'")
  system("vim '#{plan_path}'")
when 'add', '+'
  if File.exists?('tasks.todo') && ARGV[0].downcase.match("#{File.basename(Dir.pwd)}:")
    # TODO: Fails for .bitbar.
    puts "~ Appending locally."
    manager = Pomodoro::TaskManager.parse('tasks.todo')
    tasks = manager.instance_variable_get(:@tasks)
    tasks[:tasks] ||= []
    tasks[:tasks].push(Pomodoro::Task.new(ARGV.join(' ')))
    manager.save
  else
    manager.add_task_for_later(ARGV.join(' '))
    manager.save
  end
when 'edit'
  editor = ARGV.shift || ENV['EDITOR']
  exec "#{editor} #{TASK_LIST_PATH}"
when 'show-projects'
  schedule = Pomodoro::Scheduler.load(File.expand_path('~/Dropbox/Data/Data/Pomodoro/schedules/base.rb'))
  puts schedule.projects
  puts "\n#{schedule.projects.length} in total, repeats every #{((schedule.projects.length * 7) / 30.0).round(2)} months."
when 'show-schedule'
  require 'date'

  if date_string = ARGV.shift
    date = Date.parse(date_string)
  else
    date = Date.today
  end

  schedule = Pomodoro::Scheduler.load(File.expand_path('~/Dropbox/Data/Data/Pomodoro/schedules/base.rb'), date)

  puts "#{date.strftime('%A %d/%m/%Y')}:"
  schedule = schedule.for_today(true)
  puts; puts schedule
when '-h', '--help'
  require 'refined-refinements/colours'
  using RR::ColourExts
  puts(DATA.read.colourise)
  # From expenses to allow #{eval}:
  # puts DATA.read.colourise.gsub(/#\{[^}]+\}/) { |match| eval(match[2..-2]) }
else
  require 'refined-refinements/colours'
  using RR::ColourExts
  abort(DATA.read.colourise)
end

__END__

<red.bold>:: Pomodoro ::</red.bold>

<bright_black>pomodoro</bright_black> <magenta>edit</magenta>
  Open todays tasks as well as tasks for other days.

<bright_black>pomodoro</bright_black> <magenta>next</magenta>
  Start a new pomodoro from tasks.todo.

<bright_black>pomodoro</bright_black> <red>next?</red>
  Displays the next pomodoro.

<bright_black>pomodoro</bright_black> <green>today</green>
  Shows today's tasks.

<bright_black>pomodoro</bright_black> <blue.bold>punch-off</blue.bold>
  Punch off for the day.

<bright_black>pomodoro</bright_black> <blue.bold>punch-off</blue.bold> --yesterday
  Punch off for yesterday.

<bright_black>pomodoro</bright_black> <blue.bold>punch-off</blue.bold> --dry-run

<bright_black>pomodoro</bright_black> <cyan>review-and-plan</cyan>
  Create and open review and plan files for editing.

  Based on current date, it will be either:
    <blue>Weekly</blue> review & plan if it's Sunday.
    <blue>Monthly</blue> review & plan if it's the first day of a month.
    <blue>Yearly</blue> review & plan if it's the 1st of January.

  Note that as of now there is no support for quaterly reviews,
  but you can just add them manually.

<bright_black>pomodoro</bright_black> <yellow>add</yellow>
<bright_black>pomodoro</bright_black> <yellow>+</yellow>
  Add a task for later.

  Note that this is by design. You should not be adding tasks for today during the day.
  Plan in the evening and then stick to it.

<bright_black>pomodoro</bright_black> <cyan>edit</cyan>
  Edit tasks.todo using <bright_black>$EDITOR</bright_black>.

<bright_black>pomodoro</bright_black> <green.bold>show-projects</green.bold>
  Show active projects.

<bright_black>pomodoro</bright_black> <yellow.bold>show-schedule</yellow.bold>
<bright_black>pomodoro</bright_black> <yellow.bold>show-schedule 24/12/2018</yellow.bold>
